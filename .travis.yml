env:
  global:
      - DEPLOY_HOST=rpm.palette-software.com
      - DEPLOY_PATH=/var/palette-rpm-repo
      - DEPLOY_USER=palette-rpm

      # travis encrypt DEPLOY_PASS=...
      - secure: W26PLhO2jr6RQrCHW5bmZE8CVtYNkcb8n1f+15bJ/BP595wLoNQRUZpgAGawl3RnKMN4bDAUxlJ/NQy6ZMkSOwoahNGI+oUQFdSnEjPDBPuSLOGDGUqYnnzGh7/njLHYI9d6gydv5yk93rm+TkmoUOZJn5LvIGt5dXoLI821Sv+CRl6e4UTSyyhhPPMqHXWQQ77hzbhU7ot66AoUC0WgpkO2Lciz4xsH1KnopM+JT15J1j2ym0f2IzHg/+e8PD8U1Qg+AcWAY0l6LauPhor7dULCUtgHoZ4ueJflqffB1xhirWAdcMwwzv8TGPmNy4a5iRhgIUXKxJHElnJ0Z7kjm5qOJxB3VPL/pEFvqTXELm0ajCXOELuIOJp5G+8kerqJHa5StxioGzTfJNND2TW7foyeeXP/ZdDMjDqYUwLTPh9LaOnAZZQg4k4RDTuTnRBr0Nm73g0vsJdtj1MOZTxwT2iwZb0sTQgPLAGVmRR7Xi1DjWPC2mWSA2I7GbfAp3gmMjUm5+kme9jg7odxtIvmoMNkOuSg1I6pClHmF9u3sm53zY+EXk1oLmMqhYCq91515gjgPZCX46qFTouAmGiepLvN6uTZfhyTTNT/nj7r7dXSMDOJmnzTsDg09z5ZuPJN4VNgdh/24H2tWB/ld4/OOt04oPvA4kQdysUnZQocNWw=

# install the RPM package
addons:
  apt:
    packages:
      - rpm
      # To deploy the rpms, we need to ssh into places, and we dont want to store keys for now
      - sshpass

# Put a proper version string into the version file
before_script:
  - export BUILD_TAG="$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d").$TRAVIS_BUILD_NUMBER"
  - echo "==== Setting ${BUILD_TAG} as version ===="

script:
  - export VERSION_NUMBER="$(sed -n 's/Version. \([0-9]*\.[0-9]*\.[0-9]*$\)/\1/p' < reporting-framework-config.yml)"
  - export VERSION=v$VERSION_NUMBER.$TRAVIS_BUILD_NUMBER
  - mkdir -p rpm-build
  - pushd rpm-build
  - mkdir -p _build

  # Create directories
  - mkdir -p opt/insight-reporting-framework
  - mkdir -p var/log/insight-reporting-framework
  - mkdir -p etc/palette-insight-server

  # Copy the package contents
  - cp -v ../*.py opt/insight-reporting-framework
  - cp -v ../requirements.txt opt/insight-reporting-framework
  - cp -v ../*.sh opt/insight-reporting-framework
  - cp -v ../reporting-framework-config.yml etc/palette-insight-server
  - cp -v ../reporting-framework-delta-config.yml etc/palette-insight-server

  - echo "BUILDING VERSION:$VERSION"

  # build the rpm
  - rpmbuild -bb --buildroot $(pwd) --define "version $VERSION" --define "buildrelease $TRAVIS_BUILD_NUMBER" --define "_rpmdir $(pwd)/_build" ../insight-reporting-framework.spec
  - popd

deploy:
  provider: script
  script: "./deploy.sh"
  skip_cleanup: true
  on:
    branch: master

notifications:
  email: false
